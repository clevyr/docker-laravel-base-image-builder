#!/bin/sh

set -e

# Convert old dependency args to new format with defaults
if [ "$INSTALL_BCMATH" != "false" ]; then
    unset INSTALL_BCMATH
    export INSTALL="$INSTALL bcmath"
fi

if [ "$INSTALL_MYSQL" = "true" ]; then
    unset INSTALL_MYSQL
    export INSTALL="$INSTALL mysqli pdo_mysqli"
fi

if [ "$INSTALL_OPCACHE" != "false" ]; then
    unset INSTALL_OPCACHE
    export INSTALL="$INSTALL opcache"
fi

if [ "$INSTALL_PGSQL" != "false" ]; then
    unset INSTALL_PGSQL
    export INSTALL="$INSTALL pgsql pdo_pgsql"
fi

if [ "$INSTALL_SQLSRV" = "true" ]; then
    unset INSTALL_SQLSRV
    export INSTALL="$INSTALL sqlsrv pdo_sqlsrv"
fi

if [ -z "$INSTALL" ]; then
    export INSTALL="$INSTALL bcmath opcache pgsql pdo_pgsql"
fi

# Add old dependency args to new variable
INSTALL="$INSTALL $(env | grep '^INSTALL_.*=true$' | cut -d= -f1 | cut -d_ -f2- | sort | tr '[:upper:]' '[:lower:]' | tr '\n' ' ')"
export INSTALL

set -x

if echo "$INSTALL" | grep -Fq sqlsrv; then
    mkdir /tmp/sqlsrv
    cd /tmp/sqlsrv
    curl -Osf https://download.microsoft.com/download/e/4/e/e4e67866-dffd-428c-aac7-8d28ddafb39b/msodbcsql17_17.5.1.1-1_amd64.apk
    curl -Osf https://download.microsoft.com/download/e/4/e/e4e67866-dffd-428c-aac7-8d28ddafb39b/mssql-tools_17.5.1.2-1_amd64.apk
    apk add --no-cache --allow-untrusted \
        msodbcsql17_17.5.1.1-1_amd64.apk \
        mssql-tools_17.5.1.2-1_amd64.apk
    cd -
    rm -rf /tmp/sqlsrv
fi

apk add $DEPS
install-php-extensions $INSTALL
